---
layout: post
category : MCU
tagline: "Supporting tagline"
tags : [串口, MCU, USART, 数据丢失, 协议]
---
{% include JB/setup %}


由于毕设需要用上位机控制下位机，所以就想到了在串口通信的基础上定义一套自己的通信协议，用来实现上位机对单片机的复杂控制。

问题及现象
-------

大概方式就是“数据头”+“数据长度”+“数据”+“校验位”+“数据尾”这样的方式。接收到的数据在串口接收中断中处理，验证数据是否符合协议的要求。

由于串口中断在接收到每个字节后都会触发，因此每次接收完一个字节后，都需要检查一遍数据是否符合要求。我在调试程序的时候，为了方便，在每次验证完“数据头”，“数据尾”后，都会向电脑发送一串字符。但是通过观察变量发现：每次数据头验证成功后，都会影响后面的数据接收。

解决方式
------
推测原因可能是来自于验证成功后的某个语句导致。将验证成功后利用串口向上位机发送数据的语句注释掉后，程序就不再丢失数据了。串口发送语句可能会将中断长期占用，使得后续的数据不能使单片机进入中断函数。所以正确的做法可能是在主函数里通过串口向上位机发送调试信息。



